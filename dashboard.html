<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edge Proxy Metrics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 15px;
            margin: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto auto;
            gap: 15px;
            height: calc(100vh - 120px);
        }

        .status-section {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }

        .status-card {
            background: rgba(255,255,255,0.95);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            text-align: center;
        }

        .status-card h3 {
            font-size: 0.75rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .status-card .value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 2px;
        }

        .status-card .unit {
            font-size: 0.7rem;
            color: #888;
        }

        .chart-container {
            background: rgba(255,255,255,0.95);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            display: flex;
            flex-direction: column;
        }

        .chart-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 10px;
            text-align: center;
            color: #333;
        }

        .chart-wrapper {
            flex: 1;
            position: relative;
            min-height: 0;
        }

        .origin-stats {
            grid-column: 1 / -1;
            background: rgba(255,255,255,0.95);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            max-height: 200px;
            overflow-y: auto;
        }

        .origin-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .origin-table th,
        .origin-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .origin-table th {
            background: #f8f9fa;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
        }

        .failure-rate {
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .failure-rate.good { background: #d4edda; color: #155724; }
        .failure-rate.warning { background: #fff3cd; color: #856404; }
        .failure-rate.danger { background: #f8d7da; color: #721c24; }

        .refresh-info {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            backdrop-filter: blur(10px);
        }

        .loading {
            text-align: center;
            color: white;
            font-size: 1.1rem;
            margin: 50px 0;
        }

        .error {
            background: rgba(220, 53, 69, 0.9);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .status-section {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .origin-stats {
                max-height: 150px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸš€ Edge Proxy Dashboard</h1>
            <p>Real-time monitoring and metrics visualization</p>
        </div>

        <div id="loading" class="loading">
            <p>Loading metrics data...</p>
        </div>

        <div id="dashboard" style="display: none;">
            <div class="dashboard-grid">
                <!-- Status Cards Row -->
                <div class="status-section">
                    <div class="status-card">
                        <h3>Uptime</h3>
                        <div class="value" id="uptime">--</div>
                    </div>
                    <div class="status-card">
                        <h3>Total Requests</h3>
                        <div class="value" id="totalRequests">--</div>
                    </div>
                    <div class="status-card">
                        <h3>Cache Hit Ratio</h3>
                        <div class="value" id="cacheHitRatio">--</div>
                        <div class="unit">%</div>
                    </div>
                    <div class="status-card">
                        <h3>Avg Response</h3>
                        <div class="value" id="avgResponse">--</div>
                        <div class="unit">ms</div>
                    </div>
                    <div class="status-card">
                        <h3>Active Prefetch</h3>
                        <div class="value" id="activePrefetch">--</div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="chart-container">
                    <div class="chart-title">Cache & Origins</div>
                    <div class="chart-wrapper">
                        <canvas id="cacheChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-title">Prefetch & Errors</div>
                    <div class="chart-wrapper">
                        <canvas id="prefetchChart"></canvas>
                    </div>
                </div>

                <!-- Origin Stats Table -->
                <div class="origin-stats">
                    <h3 class="chart-title">Origin Performance</h3>
                    <table class="origin-table" id="originTable">
                        <thead>
                            <tr>
                                <th>Origin</th>
                                <th>Requests</th>
                                <th>Failures</th>
                                <th>Rate</th>
                            </tr>
                        </thead>
                        <tbody id="originTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="error" class="error" style="display: none;">
            <p>Failed to load metrics data. Please check if the edge proxy is running.</p>
        </div>

        <div class="refresh-info">
            Last updated: <span id="lastUpdated">--</span>
        </div>
    </div>

    <script>
        let charts = {};
        
        // Initialize charts
        function initCharts() {
            // Combined Cache & Origin Chart
            const cacheCtx = document.getElementById('cacheChart').getContext('2d');
            charts.cache = new Chart(cacheCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Cache Hits', 'Cache Misses'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: ['#28a745', '#dc3545'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 10,
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });

            // Combined Prefetch & Error Chart
            const prefetchCtx = document.getElementById('prefetchChart').getContext('2d');
            charts.prefetch = new Chart(prefetchCtx, {
                type: 'bar',
                data: {
                    labels: ['Prefetch Success', 'Prefetch Fail', 'Timeouts', 'DNS Errors', 'Conn Errors'],
                    datasets: [{
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: ['#28a745', '#dc3545', '#fd7e14', '#e83e8c', '#6610f2'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 9
                                },
                                maxRotation: 45
                            }
                        }
                    }
                }
            });
        }

        // Update dashboard with metrics data
        function updateDashboard(data) {
            // Update status cards
            document.getElementById('uptime').textContent = formatUptime(data.uptime) || '--';
            document.getElementById('totalRequests').textContent = formatNumber(data.request_count || 0);
            document.getElementById('cacheHitRatio').textContent = (data.cache_hit_ratio || 0).toFixed(1);
            document.getElementById('avgResponse').textContent = data.avg_response_time_ms || 0;
            document.getElementById('activePrefetch').textContent = data.prefetch_active || 0;

            // Update cache chart
            charts.cache.data.datasets[0].data = [
                data.cache_hits || 0,
                data.cache_misses || 0
            ];
            charts.cache.update('none');

            // Update combined prefetch & error chart
            charts.prefetch.data.datasets[0].data = [
                data.prefetch_success || 0,
                data.prefetch_failures || 0,
                data.origin_timeouts || 0,
                data.origin_dns_errors || 0,
                data.origin_conn_errors || 0
            ];
            charts.prefetch.update('none');

            // Update origin table
            const tbody = document.getElementById('originTableBody');
            tbody.innerHTML = '';
            
            const originStats = data.origin_stats || {};
            Object.keys(originStats).forEach(origin => {
                const stats = originStats[origin];
                if (stats.requests > 0) {
                    const row = document.createElement('tr');
                    const failureRateClass = 
                        stats.failure_rate < 2 ? 'good' :
                        stats.failure_rate < 10 ? 'warning' : 'danger';
                    
                    row.innerHTML = `
                        <td><strong>${origin.toUpperCase()}</strong></td>
                        <td>${formatNumber(stats.requests)}</td>
                        <td>${formatNumber(stats.failures)}</td>
                        <td><span class="failure-rate ${failureRateClass}">${stats.failure_rate.toFixed(1)}%</span></td>
                    `;
                    tbody.appendChild(row);
                }
            });

            // Update timestamp
            document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
        }

        // Helper functions for formatting
        function formatNumber(num) {
            if (num < 1000) return num.toString();
            if (num < 1000000) return (num / 1000).toFixed(1) + 'K';
            return (num / 1000000).toFixed(1) + 'M';
        }

        function formatUptime(uptime) {
            if (!uptime) return '--';
            // Convert duration string like "2h15m30s" to a more readable format
            return uptime.replace(/(\d+)h/, '$1h ').replace(/(\d+)m/, '$1m ').replace(/(\d+)s/, '$1s');
        }

        // Fetch metrics data
        async function fetchMetrics() {
            try {
                const response = await fetch('/metrics');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                
                updateDashboard(data);
            } catch (err) {
                console.error('Failed to fetch metrics:', err);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard').style.display = 'none';
                document.getElementById('error').style.display = 'block';
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            fetchMetrics();
            
            // Auto-refresh every 10 seconds
            setInterval(fetchMetrics, 10000);
        });
    </script>
</body>
</html>